<app-header />

<main class="match-detail">
  <div class="match-detail__container">

    <!-- Estado de carga -->
    @if (loading()) {
      <section class="match-detail__loading">
        <div class="spinner"></div>
        <p>Cargando datos del partido...</p>
      </section>
    }

    <!-- Error -->
    @if (error()) {
      <section class="match-detail__error">
        <p>{{ error() }}</p>
        <button class="match-detail__retry" (click)="loadMatchData()">
          Reintentar
        </button>
      </section>
    }

    <!-- Contenido del partido -->
    @if (!loading() && !error() && fixture()) {
      <!-- Marcador principal -->
      <section class="match-score">
        <a [routerLink]="['/equipo', fixture()!.teams.home.id]" class="match-score__team match-score__team--home">
          <img 
            [src]="fixture()!.teams.home.logo" 
            [alt]="fixture()!.teams.home.name"
            class="match-score__logo"
            loading="lazy"
          />
          <span class="match-score__name">{{ fixture()!.teams.home.name }}</span>
        </a>
        
        <div class="match-score__center">
          <span class="match-score__result">
            {{ fixture()!.goals.home ?? 0 }}
            <span class="match-score__separator">‚Äî</span>
            {{ fixture()!.goals.away ?? 0 }}
          </span>
        </div>
        
        <a [routerLink]="['/equipo', fixture()!.teams.away.id]" class="match-score__team match-score__team--away">
          <img 
            [src]="fixture()!.teams.away.logo" 
            [alt]="fixture()!.teams.away.name"
            class="match-score__logo"
            loading="lazy"
          />
          <span class="match-score__name">{{ fixture()!.teams.away.name }}</span>
        </a>
      </section>

      <!-- Contenido principal: Estad√≠sticas -->
      <div class="match-detail__content" [class.match-detail__content--with-comments]="showComments()">
        
        <!-- Panel de Estad√≠sticas (ocupa todo el ancho, se reduce cuando hay comentarios) -->
        <section class="match-detail__stats-panel">
          <header class="match-detail__panel-header">
            <h2 class="match-detail__panel-title">Estad√≠sticas</h2>
          </header>
          
          <div class="match-detail__panel-content">
            <!-- Goleadores -->
            <div class="goals-list">
              @for (goal of allGoals(); track goal.minute + goal.playerName) {
                <div class="goal-item" 
                     [class.goal-item--home]="goal.teamId === fixture()!.teams.home.id"
                     [class.goal-item--away]="goal.teamId === fixture()!.teams.away.id">
                  <span class="goal-item__icon">‚öΩ</span>
                  <span class="goal-item__player">
                    {{ goal.playerName }}
                    @if (getGoalIcon(goal.type)) {
                      <span class="goal-item__type">{{ getGoalIcon(goal.type) }}</span>
                    }
                  </span>
                  <span class="goal-item__minute">{{ formatMinute(goal.minute, goal.extra) }}</span>
                  @if (goal.assistName) {
                    <span class="goal-item__assist">(Asist: {{ goal.assistName }})</span>
                  }
                </div>
              }
              @if (allGoals().length === 0) {
                <p class="goals-list__empty">No hay goles en este partido</p>
              }
            </div>

            <!-- Bot√≥n para ver estad√≠sticas detalladas -->
            <button 
              class="match-detail__stats-toggle" 
              (click)="toggleStatistics()"
              type="button">
              {{ showStatistics() ? 'Ocultar estad√≠sticas' : 'Ver estad√≠sticas detalladas' }}
              <svg 
                class="match-detail__stats-toggle-icon" 
                [class.match-detail__stats-toggle-icon--open]="showStatistics()"
                width="16" 
                height="16" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>

            <!-- Estad√≠sticas detalladas (colapsable) -->
            @if (showStatistics()) {
              <div class="statistics-table">
                @for (stat of processedStats(); track stat.type) {
                  <div class="statistics-row">
                    <span class="statistics-row__home">{{ stat.homeValue }}</span>
                    <span class="statistics-row__label">{{ stat.type }}</span>
                    <span class="statistics-row__away">{{ stat.awayValue }}</span>
                  </div>
                }
                @if (processedStats().length === 0) {
                  <p class="statistics-table__empty">No hay estad√≠sticas disponibles</p>
                }
              </div>
            }

            <!-- Tarjetas -->
            @if (yellowCards().length > 0 || redCards().length > 0) {
              <div class="cards-section">
                <h3 class="cards-section__title">Tarjetas</h3>
                
                @for (card of yellowCards(); track card.time.elapsed + (card.player.name || '')) {
                  <div class="card-item card-item--yellow">
                    <span class="card-item__icon">üü®</span>
                    <span class="card-item__player">{{ card.player.name }}</span>
                    <span class="card-item__minute">{{ formatMinute(card.time.elapsed, card.time.extra) }}</span>
                    <span class="card-item__team">({{ card.team.name }})</span>
                  </div>
                }
                
                @for (card of redCards(); track card.time.elapsed + (card.player.name || '')) {
                  <div class="card-item card-item--red">
                    <span class="card-item__icon">üü•</span>
                    <span class="card-item__player">{{ card.player.name }}</span>
                    <span class="card-item__minute">{{ formatMinute(card.time.elapsed, card.time.extra) }}</span>
                    <span class="card-item__team">({{ card.team.name }})</span>
                  </div>
                }
              </div>
            }
          </div>
        </section>

        <!-- Panel de Comentarios (aparece al pulsar el bot√≥n) -->
        @if (showComments()) {
          <section class="match-detail__comments-panel">
            <header class="match-detail__panel-header">
              <h2 class="match-detail__panel-title">Comentarios</h2>
            </header>
            
            <div class="match-detail__panel-content">
              <!-- Lista de comentarios -->
              <div class="comments-list">
                @for (comment of comments(); track comment.id) {
                  <div class="comment-item" [class.comment-item--owner]="comment.isOwner">
                    <span class="comment-item__user">{{ comment.user }}</span>
                    <p class="comment-item__text">{{ comment.text }}</p>
                    @if (comment.isOwner) {
                      <button class="comment-item__delete" (click)="deleteComment(comment.id)" title="Eliminar comentario">
                        <!-- Icono de papelera -->
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 6h18"/>
                          <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                          <path d="M10 11v6"/>
                          <path d="M14 11v6"/>
                        </svg>
                      </button>
                    }
                  </div>
                }
              </div>

              <!-- Input de nuevo comentario (solo usuarios logueados) -->
              @if (isLoggedIn()) {
                <div class="comment-input">
                  <input 
                    type="text" 
                    class="comment-input__field"
                    placeholder="Escribe un comentario..."
                    [value]="newComment()"
                    (input)="updateNewComment($event)"
                    (keydown)="handleCommentKeydown($event)"
                  />
                  <button 
                    class="comment-input__submit"
                    (click)="submitComment()"
                    [disabled]="!newComment().trim()"
                    type="button"
                    title="Enviar comentario">
                    <!-- Icono de flecha de env√≠o -->
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 2L11 13"/>
                      <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                  </button>
                </div>
              } @else {
                <div class="comment-login-prompt">
                  <p>Debes <button type="button" class="comment-login-prompt__link" (click)="openLoginModal()">iniciar sesi√≥n</button> para comentar</p>
                </div>
              }
            </div>
          </section>
        }

      </div>

      <!-- Bot√≥n para mostrar/ocultar comentarios -->
      <button 
        class="match-detail__comments-toggle" 
        [class.match-detail__comments-toggle--active]="showComments()"
        (click)="toggleComments()"
        type="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        {{ showComments() ? 'Ocultar comentarios' : 'Ver comentarios' }}
        <span class="match-detail__comments-badge">{{ comments().length }}</span>
      </button>

      <!-- Navegaci√≥n: Volver -->
      <nav class="match-detail__nav">
        <a routerLink="/" class="match-detail__back">
          ‚Üê Volver al inicio
        </a>
      </nav>
    }

  </div>
</main>

<app-footer />
